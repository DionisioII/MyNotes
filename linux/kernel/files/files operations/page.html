<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Files OPerations</title>
</head><body><span style="font-family: sans-serif"><span style="font-size: 25pt">File Operations<br/>
</span></span><span style="font-size: 11pt"><span style="font-family: serif">So far, we have reserved some device numbers for our use, but we have not yet con-nected any of our driver’s operations to those numbers. The</span><span style="font-family: monospace">file_operations</span><span style="font-family: serif">struc-ture is how a char driver sets up this connection. The structure, defined in&lt;linux/fs.h&gt;,is a collection of function pointers. Each open file (represented internally by a</span><span style="font-family: monospace">file</span><span style="font-family: serif">structure, which we will examine shortly) is associated with its own set of functions(by including a field called</span><span style="font-family: monospace">f_op</span><span style="font-family: serif">that points to a</span><span style="font-family: monospace">file_operations</span><span style="font-family: serif">structure). Theoperations are mostly in charge of implementing the system calls and are therefore,namedopen,read, and so on. We can consider the file to be an “object” and thefunctions operating on it to be its “methods,” using object-oriented programmingterminology to denote actions declared by an object to act on itself. This is the firstsign of object-oriented programming we see in the Linux kernel, and we’ll see morein later chapters.Conventionally, a</span><span style="font-family: monospace">file_operations</span><span style="font-family: serif">structure or a pointer to one is called</span><span style="font-family: monospace">fops</span><span style="font-family: serif">(orsome variation thereof ). Each field in the structure must point to the function in thedriver that implements a specific operation, or be left</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">for unsupported opera-tions. The exact behavior of the kernel when a</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">pointer is specified is differentfor each function, as the list later in this section shows.The following list introduces all the operations that an application can invoke on adevice. We’ve tried to keep the list brief so it can be used as a reference, merely sum-marizing each operation and the default kernel behavior when a</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">&nbsp;pointer is used.<br/>
</span><span style="font-family: serif"><br/>
<br/>
</span></span><span style="font-size: 11pt"><span style="font-family: serif">struct</span></span>&nbsp;file_operations contains:<br/>
<br/>
<span style="font-size: 15pt">s</span><span style="font-size: 9pt"><span style="font-family: monospace">truct module *owner</span><span style="font-family: serif">The first</span><span style="font-family: monospace">file_operations</span><span style="font-family: serif">field is not an operation at all; it is a pointer to themodule that “owns” the structure. This field is used to prevent the module frombeing unloaded while its operations are in use. Almost all the time, it is simplyinitialized to</span><span style="font-family: monospace">THIS_MODULE</span><span style="font-family: serif">, a macro defined in&lt;linux/module.h&gt;.</span><span style="font-family: monospace">loff_t (*llseek) (struct file *, loff_t, int);</span><span style="font-family: serif">Thellseekmethod is used to change the current read/write position in a file, andthe new position is returned as a (positive) return value. The</span><span style="font-family: monospace">loff_t</span><span style="font-family: serif">parameter isa “long offset” and is at least 64 bits wide even on 32-bit platforms. Errors aresignaled by a negative return value. If this function pointer is</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">, seek calls willmodify the position counter in the</span><span style="font-family: monospace">file</span><span style="font-family: serif">structure (described in the section “Thefile Structure”) in potentially unpredictable ways.</span><span style="font-family: monospace">ssize_t (*read) (struct file *, char __user *, size_t, loff_t *);</span><span style="font-family: serif">Used to retrieve data from the device. A null pointer in this position causes thereadsystem call to fail with</span><span style="font-family: monospace">-EINVAL</span><span style="font-family: serif">(“Invalid argument”). A nonnegative returnvalue represents the number of bytes successfully read (the return value is a“signed size” type, usually the native integer type for the target platform).</span><span style="font-family: monospace">ssize_t (*aio_read)(struct kiocb *, char __user *, size_t, loff_t);</span><span style="font-family: serif">Initiates an asynchronous read—a read operation that might not completebefore the function returns. If this method is</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">, all operations will be pro-cessed (synchronously) byread instead.</span><span style="font-family: monospace">ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);</span><span style="font-family: serif">Sends data to the device. If</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">,</span><span style="font-family: monospace">-EINVAL</span><span style="font-family: serif">is returned to the program calling thewritesystem call. The return value, if nonnegative, represents the number ofbytes successfully written.</span><span style="font-family: monospace">ssize_t (*aio_write)(struct kiocb *, const char __user *, size_t, loff_t *);</span><span style="font-family: serif">Initiates an asynchronous write operation on the device.</span><span style="font-family: monospace">int (*readdir) (struct file *, void *, filldir_t);</span><span style="font-family: serif">This field should be</span><span style="font-family: monospace">NULL</span><span style="font-family: serif">for device files; it is used for reading directories and isuseful only for filesystems.</span></span></body></html>